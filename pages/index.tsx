import Head from 'next/head';
import React, { useEffect, useState } from 'react';
import styles from '../styles/Home.module.css';
import { useRouter } from 'next/router';
import { getStravaAthlete, getStravaUrl } from './api/strava';
import StarvaConnect from '../public/strava_connect.svg';
import PoweredByStrava from '../public/powered_by_strava.svg';
import dynamic from 'next/dynamic';
import {
  MapSearchUpdateParams,
  MapSelection,
  SegmentExploreParams,
  SegmentExploreResponse,
  StravaSegment,
} from './api/types';
import useLocalStorageNoState from './useLocalStorageNoState';

type Token = {
  expires_at: number;
  expires_in: number;
  refresh_token: string;
  access_token: string;
};

type User = {
  name: string | undefined;
  token: Token | undefined;
};

type HomeProps = {
  stravaLoginUrl: string;
  stravaUser: User;
};

const DISCLAIMER = `Site doesn't store any of your personal information from Strava. Close the tab or refresh and all information is gone`;
const HELSINKI_LOCATION: [number, number] = [60.192059, 24.945831];
const DEFAULT_ZOOM = 13;
const DEFAULT_STATE = { center: HELSINKI_LOCATION, zoom: DEFAULT_ZOOM };
const DEFAULT_USER: User = { name: undefined, token: undefined };

const MapWithNoSSR = dynamic(() => import('./Map'), { ssr: false });

const Home = ({ stravaLoginUrl, stravaUser }: HomeProps) => {
  const [user] = useState<User>(stravaUser ?? DEFAULT_USER);
  const [loading, setLoading] = useState<boolean>(false);
  const [mapSelection, setMapSelection] = useLocalStorageNoState<MapSelection>('location', DEFAULT_STATE);
  const [segments, setSegments] = useState<StravaSegment[]>([]);
  const router = useRouter();

  console.log('Strava user:', stravaUser);
  console.log({ mapSelection });

  useEffect(() => {
    // Remove query params
    router.push('/', undefined, { shallow: true });
  }, []);

  const login = () => {
    setLoading(true);
    location.href = stravaLoginUrl;
  };

  const mapUpdateEvent = async (params: MapSearchUpdateParams) => {
    const { mapSelection, searchParams } = params;
    // No need to re-render when we are already at the same location
    setMapSelection(mapSelection);
    await updateSegments(searchParams);
  };

  const updateSegments = async (params: SegmentExploreParams) => {
    if (!user.token) return;

    console.log(params);

    setLoading(true);

    const segmentResponse = await fetch('/api/strava', {
      method: 'POST',
      headers: { Authorization: user.token.access_token },
      body: JSON.stringify(params),
    });

    const data = (await segmentResponse.json()) as SegmentExploreResponse;
    console.log(data.segments);

    setSegments(data.segments);
    setLoading(false);
  };

  const MainContent = () => {
    const loginContent = loading ? (
      <LoadingComponent />
    ) : (
      <>
        <h3 className={styles.title}>Welcome {user.name}</h3>
        {user.token ? null : <StravaLoginButton loginAction={() => login()} />}
      </>
    );

    return (
      <>
        <main className={styles.main}>{loginContent}</main>
        <MapWithNoSSR segments={segments} mapSelection={mapSelection} mapUpdateEvent={mapUpdateEvent} />
      </>
    );
  };

  return (
    <div className={styles.container}>
      <Head>
        <title>Strava Segment Explorer</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <MainContent />

      <div>{DISCLAIMER}</div>

      <footer style={{ width: '30%' }}>
        <PoweredByStrava />
      </footer>
    </div>
  );
};

const LoadingComponent = () => (
  <div>
    <h2>Loading...</h2>
  </div>
);

const StravaLoginButton = ({ loginAction }: { loginAction: () => void }) => (
  <div onClick={() => loginAction()} style={{ cursor: 'pointer' }}>
    <StarvaConnect />
  </div>
);

// Need to return null instead of undefined
// Reason: `undefined` cannot be serialized as JSON. Please use `null` or omit this value.
const stravaAtheleteToUser = (stravaAthlete: any): User | null =>
  stravaAthlete
    ? {
        name: stravaAthlete.athlete.firstname,
        token: {
          expires_at: stravaAthlete.expires_at,
          expires_in: stravaAthlete.expires_in,
          access_token: stravaAthlete.access_token,
          refresh_token: stravaAthlete.refresh_token,
        },
      }
    : null;

export const getServerSideProps = async (context: any) => {
  const stravaLoginUrl = getStravaUrl();
  const stravaAthlete = context.query.code ? await getStravaAthlete(context.query.code.toString()) : null;
  const stravaUser = stravaAtheleteToUser(stravaAthlete);

  console.log('Server side props:', { stravaLoginUrl, stravaUser });

  return {
    props: {
      stravaLoginUrl,
      stravaUser,
    },
  };
};

export default Home;
